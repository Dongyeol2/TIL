# DHCP(Dynamic Host Configuration Protocol)

- **DHCP** : 네트워크 상에서 동적으로 IP주소 및 기타 구성정보 등을 부여/관리하는 프로토콜

- **DHCP Protocol 구성요소**

  /- IP 주소 및 다른 TCP/IP 매개변수를 할당하기 위한 Mechanism

  /- Host 전용 정보를 조성하고 송신하기 위한 Protocol

- **DHCP 동적할당시 장점**

  1. COST 절약 : 사용자 중 PC를 켠 사용자만 IP가 할당되어 고정 IP에 비해 IP절약 효과가 있다.

  2. 효율적인 네틍워크 관리 : IP 방식에 비해 사용자 IP 망 설계변경이 자유롭다.

     사용자에게 DHCP IP를 할당할 경우 네트워크 정보가 바뀌더라도 DHCP 서버에만 네트워크 정보를 변경해 주면 되므로 네트워크 정보 변경이 유연하다.

- **DHCP 동적할당시 단점**

  1. DHCP 요구 단말은 초기 부팅시 broadcast 트래픽(DHCP Discover 메세지)을 유발

     /> 한 개의 VLAN의 설정범위에 있는 모든 단말에 전송되므로 네트워크의 성능 저하 발생 가능

  2. PC전원을 OFF할 경우 Lease Time까지 IP가 다른 단말에 할당되지 못하게 되어 IP주소 낭비가 발생하게 된다.

  3. IP를 할당해주는 서버에 전적으로 의존

     /> 서버가 다운되면 IP를 받을 수 없으므로 인터넷을 사용할 수 없게 된다.

- DHCP 특징

  1. 클라이언트/서버 형태의 동작

     /- 동적인 구성 정보를 요청/제공하는 프로토콜

     /- DHCP 클라이언트(요청) 및 서버(응답)가 동일 서브넷에 함께 있을 수도, 다른 망에 분리될 수도 있음(이 경우 DHCP 중계 에이전트가 작동)

  2. 프로토콜 및 포트

     /- 수송(Transport Layer)용 프로토콜 : UDP

     /- 사용 포트

     DHCPv4 : 67(서버용), 68(클라이언트용)

     DHCPv6 : 546(서버 송출, 클라이언트 청취), 547(서버 청취, 클라이언트 송출)

  3. DHCP 탐색(Discover) / 요청(Request)때 쓰이는 IP 헤더 내 IP주소

     /- IP헤더 내 발신지 주소 : 0.0.0.0

     /- IP헤더 내 목적지 주소

     DHCPv4 : 255.255.255.255(브로드캐스트 주소)

     DHCPv6 : ALL_DHCP_Relay_Agents_and_Servers (FFD2::1:2),

     ALL_DHCP_Server (FF05::1:3)

     *요청 받는 서버에서는 요청 클라이언트의 MAC 주소를 기억하고, 이를 IP 주소와의 매핑시 이용한다.

- **DHCP 기본 동작 원리**

  1. Discover (발견)

     /- 동일 서브넷에 위치하는 DHCP 서버를 찾기 위해 DHCP Discover 메세지를 이더넷 망에 브로드캐스트한다. 이를 통해 동일 서브넷 상에 있는 모든 DHCP 서버들은 이 메세지를 수신한다.

  2. Offer (제공)

     /- Discover 메세지를 수신한 DHCP 서버는 DHCP Offer 메세지를 이더넷 망에 브로드캐스팅하며, 해당 메세지 내에는 단말이 필요로 하는 네트워크 정보들(단말 IP, 서브넷마스크, Default Gateway, DNS 주소, Lease Time 등)이 포함되어 있다.

  3. Request(요청)

     /- DHCP Offer 메세지를 수신한 단말은 동일 서브넷에 DHCP 서버가 존재한다는 것을 알아차리고, 단말 IP주소를 포함한 네트워크 정보를 요청하기 위해 DHCP 서버네 DHCP Request 메세지를 이더넷망에 브로드캐스팅한다.

     /- 동일 서브넷

  4. Ack(수락)

     /- DHCP 서버가 클라이언트 자신이 사용할 구성정보 제안에 대한 수락메세지

  ![DHCP](./IMGS/DHCP.PNG)

- **Client - Server 동작절차(초기 구성 절차)**

  클라이언트는 IP주소와 다른 파라미터들을 요구

  1. DHCP Discover 메세지를 브로드캐스트
  2. 서브들은 DHCP Offer메세지를 브로드캐스트
  3. 클라이언트는 하나의 서버를 선택하여 선택된 서버에게 DHCP Request 메세지를 전송
  4. 선택된 서버는 DHXP ACK 또는 DHCP NAK 메세지를 브로드캐스트한다.

  /* 클라이언트가 DHCP NAK을 받을 경우 3으로 다시

  /* 클라이언트가 어떤 응답도 받지 못했을 경우 1로 다시

  

  /*클라이언트는 DHCP Discover 메세지에서 원하는 IP주소를 제안할 수 있다.

  /* 클라이언트는 선택한 서버의 IP 주소를 알고 있는 경우에도 DHCPREQUEST를 브로드캐스트한다.(다른 서버들이 선택되지 못했다는 것을 알리기 위해)

- **Client - Server 동적절차(대여 갱신)**

  1. 대여 기간의 1/2(T1)이 경과한 후에 클라이언트는 대여한 서버에게 DHCP Request를 전송(Renewing State)

  2. 서버는 클라이언트에게 DHCP ACK 또는 DHCP NAK을 전송

     /- 만약 DHCP NAK을 수신하면, 클라이언트는 DHCP Discover을 사용하여 새로운 주소를 획득해야 한다.

     /- T2(0.875 * lease_duration) (지속)) 시작 전에 DHCP ACK를 수신하지 못하면 (Rebinding state), DHCP Request를 브로드캐스트 한다.

     /- lease_expire(만료되다)전에 DHCP ACK를 수신하지 못하면, 초기단계부터 다시 시작

     

     /* "Server identifier"옵션을 포함하지 않음으로써 기존 대여 확장 요구라는 것을 서버에게 알린다.

     /- 이 옵션이 있는 경우, DHCP Offer에 대한 응답

     /- 대여 시간이나 다른 옵션들은 포함될 수 있다.

     /* 현재의 네트워크 주소를 ciaddr에 채워서 전송

     /* 클라이언트와 서버 모두 서로의 주소를 알고 있으므로 초기 통신은 유니캐스트를 사용한다.

- **Client - Server 동작절차(Rebooting)**

  1. 클라이언트는 "Request IP Address"옵션을 갖는 DHCP Request를 브로드캐스트 한다.

     /- "server identifier"옵션은 비포함

     /- "ciaddr"은 Zero로 설정

  2. 서버는 클라이언트에게 DHCP ACK 또는 DHCP NAK을 전송

     /- 만약 DHCP NAK을 수신하면, 클라이언트는 DHCP Discover을 사용하여 새로운 주소를 획득해야 한다.

     /- 서버는 클라이언트에 대한 정보가 없을 경우에는 응답하지 말아야 한다.

- **DHCP Relay Agent**

  /- DHCP 서버가 없는 서브넷으로부터 다른 서브넷에 존재하는 1이상의 DHCP 서버에게 DHCP 또는 BOOTP 요청을 중계(Relay) 해줌

  /- DHCP Relay Agent는 "giaddr"필드에 자신의 주소를 적는다.

  /- 서버는 DHCP 요청이 Relay를 통해 전송되었는지를 확인할 수 있다.

- IP 를 할당하기 이전에, DHCP 서버 관리자는 서버에 할당할 IP주소와 서브넷마스트, Default 게이트웨이를 설정한다. 클라이언트는 처음 네트워크에 연결되면 **DHCP Discover(UDP, 목적지 포트번호 : 67)**를 Broadcast를 날려 서버를 찾는다. ARP Request에서 Broadcast가 쓰인 것과 유사하다. 패킷을 받은 서버는 본인의 IP주소 정보가 포함된 **DHCP Offer(UDP, 목적지 포트번호 : 68)를 통해 클라이언트에게 사용해도 좋을 네트워크 설정을 제안한다.단, 다른 서버가 같은 IP주소를 이미 할당했을 수도 있기 떄문에 주소를 배포하기 전 ICMP 에코 요청 패킷을 보내 기존에 사용 중인 IP가 아닌지  확인한다.

  클라이언 역시 Offer 받은 IP주소에 대해 ARP Request를 Broadcast로 보내 중복 사용여부를 체크한 후 **DHCP Request(UDP, 목적지 포트번호 : 67)**를 Broadcast로 보낸다. 최종적으로서버가 DHCP Reqeust에 대한 응답인 **DHCP ACK(UDP, 목적지 포트번호 : 68)**를 보내게 되면 IP할당이 끝나며, 클라이언트는 ACK 메시지를 포함한 IP Lease Time 만큰 IP주소를 임대하여 사용할 수 있게 된다.

  /* DHCP의 IP할당이 두 번에 걸쳐 이루어지는 이유 : DHCP 서버가 2대 이상일 경우에도 정상 동작하기 위해서

  /* DHCP Request를 Broadcast방식으로 보내는 이유 : DHCP 서버가 2대 이상일 경우, 클라이언트로부터 선택되지 않은 DHCP 서버에서는 자신이 Offer했던 정보들을 지워야하기 때문이다. 그래야 다른 클라이언트들에게 그 IP주소를 새롭게 줄 수 있다.

- DHCP에 의해 네트워크 설정이 완료된 클라이언트는 TCP/IP 통신이 가능해진다. 그렇게 인터넷을 사용하다가 IP주소를 그만 사용하고 싶을 땐 서버에게 DHCP Release 패킷을 Unicast로 보내 IP를 반납한다. 또, DHCP Lease Time의 50%가 지나면 클라이언트는 서버에게 다시 DHCP Request를 보내 임대기간 연장을 요청한다. 이 때 클라이언트는 이미 자신의 IP주소를 가지고 있고 서버의 IP를 알고 있기 때문에 Unicast로 패킷을 보낸다. DHCP Request를 받은 서버는 클라이언트에게 임대기간을 포함한 네트워크 설정 정보를 다시 Unicast로 보내준다.